name: Build packages

on:
  workflow_call:
    inputs:
      mirror: 
        type: string
      packages:
        type: string
      debug:
        type: boolean
        default: false

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      archs: ${{ steps.set_env.outputs.archs }}
      branch: ${{ steps.set_env.outputs.branch }}
      branch_number: ${{ steps.set_env.outputs.branch_number }}
      artifact_packages_rel: ${{ steps.set_env.outputs.artifact_packages_rel }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - uses: actions/checkout@v5
        with:
          repository: czy21/share
          path: feeds/share
      - name: Set env
        id: set_env
        run: |
          mv feeds/share/.github/workflows/scripts .github/workflows/
          branch="${GITHUB_REF#refs/heads/}"
          branch_number=$(echo $branch | sed 's|openwrt-||')

          artifact_packages_rel=releases/packages-${branch_number}
          
          if [ "${branch}" == "main" ];then
            artifact_packages_rel=snapshots/packages
          fi

          echo "branch=${branch}" >> "$GITHUB_OUTPUT"
          echo "branch_number=${branch_number}" >> "$GITHUB_OUTPUT"
          echo "artifact_packages_rel=${artifact_packages_rel}" >> "$GITHUB_OUTPUT"

          wget https://mirrors.pku.edu.cn/files/openwrt/$artifact_packages_rel/ -O packages.json

          python3 -B .github/workflows/scripts/openwrt-get_targets.py | while read v;do echo "$v" >> "$GITHUB_OUTPUT"; done
  
  build:
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    needs: setup
    strategy:
       fail-fast: false
       matrix:
         arch: ${{fromJson(needs.setup.outputs.archs)}}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Determine packages
        run: |
          PACKAGES="${{ inputs.packages }}"
          if [ "${{ github.event_name }}" = "push" ];then
            # only detect packages with changes
            PKG_ROOTS=$(find . -name Makefile | grep -v ".*/src/Makefile" | sed -e 's@./\(.*\)/Makefile@\1/@')
            CHANGES=$(git diff --diff-filter=d --name-only HEAD~)
  
            for ROOT in $PKG_ROOTS; do
              for CHANGE in $CHANGES; do
                if [[ "$CHANGE" == "$ROOT"* ]]; then
                  PACKAGES+=$(echo "$ROOT" | sed -e 's@.*/\(.*\)/@\1 @')
                  break
                fi
              done
            done

          fi
          PACKAGES="${PACKAGES:-luci-app-attendedsysupgrade}"

          echo "Building $PACKAGES"
          echo "PACKAGES=$PACKAGES" >> $GITHUB_ENV

      - name: Build
        uses: openwrt/gh-action-sdk@v9
        env:
          ARCH: ${{ matrix.arch }}-${{ needs.setup.outputs.branch }}
          FEEDNAME: packages_ci
          V: ${{ inputs.debug && 's' || '' }}

      - name: Move created packages to project dir
        run: |
          ls -alR bin/packages || true
          
          artifact_dir=bin/artifact/${{ matrix.arch }}/plugin
          mkdir -p ${artifact_dir}

          find bin/packages/${{ matrix.arch }}/packages_ci \( -name "*.ipk" -o -name "*.apk" \) -exec cp -rv {} ${artifact_dir} \; || true

      - name: Store packages
        uses: actions/upload-artifact@v4
        with:
          retention-days: 1
          name: ${{ matrix.arch }}-packages
          path: bin/artifact/

      - name: Store logs
        uses: actions/upload-artifact@v4
        with:
          retention-days: 1
          name: ${{ matrix.arch }}-logs
          path: "logs/"

  deploy:
    name: Deploy
    runs-on: self-hosted
    needs: [setup,build]
    if: always()
    container:
      image: openwrt/sdk:x86-64-${{ needs.setup.outputs.branch }}
      volumes:
        - openwrt-sdk-x86-64-${{ needs.setup.outputs.branch }}-${{ github.run_id }}:/builder
        - openwrt-share:/data/
      options: --user root --privileged --pull always
    steps:
      - name: Set env
        id: set_env
        shell: bash
        run: |
          download_packages_dir=/data/download/${{ needs.setup.outputs.artifact_packages_rel }}
          echo "download_packages_dir=${download_packages_dir}" >> "$GITHUB_OUTPUT"

      - name: Setup
        working-directory: /builder
        shell: su buildbot -c "bash {0}"
        run: |
          mkdir -p ${{ steps.set_env.outputs.download_packages_dir }}

          if [ -f setup.sh ];then
            sed -i "s|^sha256sum -c|#\0|" setup.sh
            UPSTREAM_URL=${{ inputs.mirror }} bash setup.sh
          fi
          make defconfig

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          path: ${{ steps.set_env.outputs.download_packages_dir }}
          pattern: '*-packages'
          merge-multiple: true

      - name: Modify permission
        run: chown -R buildbot:buildbot ${{ steps.set_env.outputs.download_packages_dir }}

      - name: Generate index
        working-directory: /builder
        shell: su buildbot -c "bash {0}"
        run: |
          ln -snf /data/pri.key key-build
          sed -i -e 's|--sign $(BUILD_KEY_APK_SEC)|--allow-untrusted|' package/Makefile
          for t in $(find ${{ steps.set_env.outputs.download_packages_dir }} -type d -name 'plugin');do
            echo "Generating index for package ${t}"
            make -j4 package/index V=s PACKAGE_SUBDIRS=$t
          done

  clean:
    name: Clean
    runs-on: self-hosted
    needs: [setup,build,deploy]
    if: always()
    steps:
      - run: |
          volume_names=$(docker volume ls -q | grep 'openwrt-sdk-x86-64-${{ needs.setup.outputs.branch }}-${{ github.run_id }}$' || true | xargs )
          if [ -n "${volume_names}" ];then
            docker volume rm $volume_names
          fi